#!/usr/bin/env bash

#if [[ "$CIRRUS_TAG" == "" ]]; then
  #echo "Not a release. No need to deploy!"
  #exit 0
#fi

if [[ "$GITHUB_TOKEN" == "" ]]; then
  echo "Please provide GitHub access token via GITHUB_TOKEN environment variable!"
  exit 1
fi

file_content_type="application/octet-stream"
files_to_upload=(
  # relative paths of assets to upload
  #dtlv-${CIRRUS_TAG}-macos-latest-aarch64.zip
  dtlv-0.7.12-macos-latest-aarch64.zip
)

for fpath in $files_to_upload
do
  echo "Uploading $fpath..."
  #url_to_upload="https://uploads.github.com/repos/$CIRRUS_REPO_FULL_NAME/releases/$CIRRUS_TAG/assets?name=$fpath"
  url_to_upload="https://uploads.github.com/repos/juji-io/datalevin/releases/0.7.12/assets?name=$fpath"
  curl --http1.1 -X POST \
    --data-binary @$fpath \
    --header "Accept: application/vnd.github+json" \
    --header "Authorization: token $GITHUB_TOKEN" \
    --header "Content-Type: $file_content_type" \
    $url_to_upload
done

exit 0
